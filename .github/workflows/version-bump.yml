name: Version Bump PR

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: Branch to update
        required: true
        type: string
        default: main
      bump:
        description: Which segment to bump
        required: true
        type: choice
        default: patch
        options:
          - patch
          - minor
          - major
      release:
        description: Apply Release label (tag + draft release after merge)
        required: true
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: version-bump-${{ github.event.inputs.target_branch }}
  cancel-in-progress: false

jobs:
  bump:
    runs-on: ubuntu-latest
    name: Bump package.json Version

    steps:
      - name: Checkout target branch
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.target_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: Configure Git author
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Bump package.json version
        id: bump
        env:
          BUMP_TYPE: ${{ inputs.bump }}
        run: |
          set -euo pipefail

          OLD_VERSION="$(node -p "require('./package.json').version")"
          NEW_VERSION="$(node <<'NODE'
          const fs = require('node:fs')

          const bumpType = process.env.BUMP_TYPE
          const pkgPath = 'package.json'
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'))
          const match = String(pkg.version).match(/^(\d+)\.(\d+)\.(\d+)$/)

          if (!match) {
            throw new Error(`Unsupported version format: ${pkg.version}`)
          }

          let major = Number(match[1])
          let minor = Number(match[2])
          let patch = Number(match[3])

          if (bumpType === 'major') {
            major += 1
            minor = 0
            patch = 0
          } else if (bumpType === 'minor') {
            minor += 1
            patch = 0
          } else if (bumpType === 'patch') {
            patch += 1
          } else {
            throw new Error(`Unsupported bump type: ${bumpType}`)
          }

          const nextVersion = `${major}.${minor}.${patch}`
          pkg.version = nextVersion
          fs.writeFileSync(pkgPath, `${JSON.stringify(pkg, null, 2)}\n`)
          process.stdout.write(nextVersion)
          NODE
          )"

          echo "old_version=${OLD_VERSION}" >> "$GITHUB_OUTPUT"
          echo "new_version=${NEW_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Bumped version ${OLD_VERSION} -> ${NEW_VERSION}"

      - name: Prepare PR metadata
        id: prepare
        env:
          TARGET_BRANCH: ${{ inputs.target_branch }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
        run: |
          set -euo pipefail

          SAFE_TARGET_BRANCH="$(echo "${TARGET_BRANCH}" | tr '/ ' '--' | tr -cd '[:alnum:]._-')"
          PR_BRANCH="automation/version-bump/${SAFE_TARGET_BRANCH}/v${NEW_VERSION}"

          echo "pr_branch=${PR_BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Commit and push version bump branch
        id: branch
        env:
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          PR_BRANCH: ${{ steps.prepare.outputs.pr_branch }}
        run: |
          set -euo pipefail

          if git diff --quiet -- package.json; then
            echo "No changes detected in package.json."
            exit 1
          fi

          git checkout -B "${PR_BRANCH}"
          git add package.json
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git push --force origin "${PR_BRANCH}"

      - name: Build pull request body
        id: body
        env:
          TARGET_BRANCH: ${{ inputs.target_branch }}
          OLD_VERSION: ${{ steps.bump.outputs.old_version }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          BUMP_TYPE: ${{ inputs.bump }}
          RELEASE_REQUESTED: ${{ inputs.release }}
        run: |
          set -euo pipefail

          BODY_FILE="${RUNNER_TEMP}/version-bump-pr-body.md"
          cat > "${BODY_FILE}" <<EOF
          ## Summary
          - bump \`package.json\` version from \`${OLD_VERSION}\` to \`${NEW_VERSION}\`
          - generated by \`Version Bump PR\` workflow

          ## Details
          - target branch: \`${TARGET_BRANCH}\`
          - bump type: \`${BUMP_TYPE}\`
          - release label requested: \`${RELEASE_REQUESTED}\`
          EOF

          echo "body_file=${BODY_FILE}" >> "$GITHUB_OUTPUT"

      - name: Find existing version bump pull request
        id: find_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          PR_BRANCH: ${{ steps.prepare.outputs.pr_branch }}
        run: |
          set -euo pipefail

          EXISTING_PR_NUMBER="$(gh pr list \
            --repo "${GITHUB_REPOSITORY}" \
            --base "${TARGET_BRANCH}" \
            --head "${PR_BRANCH}" \
            --state open \
            --json number \
            --jq '.[0].number // ""')"

          if [ -n "${EXISTING_PR_NUMBER}" ]; then
            echo "Found existing PR #${EXISTING_PR_NUMBER} for ${PR_BRANCH}."
          else
            echo "No existing PR found for ${PR_BRANCH}; a new PR will be created."
          fi

          echo "existing_pr_number=${EXISTING_PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Create or update version bump pull request
        id: upsert_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TARGET_BRANCH: ${{ inputs.target_branch }}
          PR_BRANCH: ${{ steps.prepare.outputs.pr_branch }}
          BODY_FILE: ${{ steps.body.outputs.body_file }}
          NEW_VERSION: ${{ steps.bump.outputs.new_version }}
          EXISTING_PR_NUMBER: ${{ steps.find_pr.outputs.existing_pr_number }}
        run: |
          set -euo pipefail

          if [ -n "${EXISTING_PR_NUMBER}" ]; then
            if ! gh pr edit "${EXISTING_PR_NUMBER}" \
              --repo "${GITHUB_REPOSITORY}" \
              --title "chore: bump version to ${NEW_VERSION}" \
              --body-file "${BODY_FILE}"; then
              echo "Failed to update existing PR #${EXISTING_PR_NUMBER}."
              exit 1
            fi
          else
            CREATE_OUTPUT=""
            if ! CREATE_OUTPUT="$(gh pr create \
              --repo "${GITHUB_REPOSITORY}" \
              --base "${TARGET_BRANCH}" \
              --head "${PR_BRANCH}" \
              --title "chore: bump version to ${NEW_VERSION}" \
              --body-file "${BODY_FILE}" 2>&1)"; then
              echo "Failed to create PR for ${PR_BRANCH} -> ${TARGET_BRANCH}."
              echo "${CREATE_OUTPUT}"
              exit 1
            fi
            echo "${CREATE_OUTPUT}"
          fi

          PR_NUMBER="$(gh pr list \
            --repo "${GITHUB_REPOSITORY}" \
            --base "${TARGET_BRANCH}" \
            --head "${PR_BRANCH}" \
            --state open \
            --json number \
            --jq '.[0].number // ""')"
          PR_URL="$(gh pr list \
            --repo "${GITHUB_REPOSITORY}" \
            --base "${TARGET_BRANCH}" \
            --head "${PR_BRANCH}" \
            --state open \
            --json url \
            --jq '.[0].url // ""')"

          if [ -z "${PR_NUMBER}" ] || [ -z "${PR_URL}" ]; then
            echo "Could not resolve PR metadata after create/update."
            gh pr list \
              --repo "${GITHUB_REPOSITORY}" \
              --base "${TARGET_BRANCH}" \
              --head "${PR_BRANCH}" \
              --state open \
              --json number,url
            exit 1
          fi

          echo "pull_request_number=${PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "pull_request_url=${PR_URL}" >> "$GITHUB_OUTPUT"

      - name: Ensure Release label exists
        if: inputs.release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_LABEL: Release
        run: |
          set -euo pipefail

          if gh api --silent --method GET "repos/${GITHUB_REPOSITORY}/labels/${RELEASE_LABEL}" >/dev/null 2>&1; then
            echo "Label ${RELEASE_LABEL} already exists."
            exit 0
          fi

          if ! gh api --method POST "repos/${GITHUB_REPOSITORY}/labels" \
            -f name="${RELEASE_LABEL}" \
            -f color="0e8a16" \
            -f description="Create a post-merge version tag and draft release" >/dev/null; then
            echo "Failed to create label ${RELEASE_LABEL}."
            exit 1
          fi

      - name: Apply Release label to pull request
        if: inputs.release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.upsert_pr.outputs.pull_request_number }}
          RELEASE_LABEL: Release
        run: |
          set -euo pipefail

          if ! gh pr edit "${PR_NUMBER}" \
            --repo "${GITHUB_REPOSITORY}" \
            --add-label "${RELEASE_LABEL}"; then
            echo "Failed to add label ${RELEASE_LABEL} to PR #${PR_NUMBER}."
            exit 1
          fi

      - name: Remove Release label from pull request
        if: ${{ !inputs.release }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.upsert_pr.outputs.pull_request_number }}
          RELEASE_LABEL: Release
        run: |
          set -euo pipefail

          gh pr edit "${PR_NUMBER}" \
            --repo "${GITHUB_REPOSITORY}" \
            --remove-label "${RELEASE_LABEL}" >/dev/null 2>&1 || true

      - name: Print results
        run: |
          echo "pull_request_url=${{ steps.upsert_pr.outputs.pull_request_url }}"
          if [ "${{ inputs.release }}" = "true" ]; then
            echo "release_label=Release"
            echo "post_merge_release=v${{ steps.bump.outputs.new_version }}"
          fi
